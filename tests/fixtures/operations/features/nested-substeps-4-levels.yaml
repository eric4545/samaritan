name: Nested Sub-Steps (4 Levels)
version: 1.0.0
description: Test 4 levels of nested sub-steps (maximum practical depth)

environments:
  - name: staging
  - name: production

steps:
  - name: Full Stack Deployment
    type: manual
    phase: flight
    description: Complete application stack with all dependencies
    sub_steps:
      - name: Infrastructure Layer
        type: manual
        instruction: Setup infrastructure components
        sub_steps:
          - name: Network Configuration
            type: automatic
            command: terraform apply -target=module.networking
            sub_steps:
              - name: Create VPC
                type: automatic
                command: aws ec2 create-vpc --cidr-block 10.0.0.0/16
                sub_steps:
                  - name: Tag VPC Resources
                    type: automatic
                    command: aws ec2 create-tags --resources ${VPC_ID} --tags Key=Environment,Value=${ENV}
                  - name: Enable DNS Hostnames
                    type: automatic
                    command: aws ec2 modify-vpc-attribute --vpc-id ${VPC_ID} --enable-dns-hostnames
              - name: Configure Security Groups
                type: automatic
                command: aws ec2 create-security-group --group-name app-sg
                sub_steps:
                  - name: Add Ingress Rules
                    type: automatic
                    command: aws ec2 authorize-security-group-ingress --group-id ${SG_ID} --protocol tcp --port 443
                  - name: Add Egress Rules
                    type: automatic
                    command: aws ec2 authorize-security-group-egress --group-id ${SG_ID} --protocol -1
          - name: Load Balancer Setup
            type: automatic
            command: aws elbv2 create-load-balancer --name app-lb
            sub_steps:
              - name: Configure Target Groups
                type: automatic
                command: aws elbv2 create-target-group --name app-targets
                sub_steps:
                  - name: Register Targets
                    type: automatic
                    command: aws elbv2 register-targets --target-group-arn ${TG_ARN}
                    sub_steps:
                      - name: Configure Health Checks
                        type: automatic
                        command: aws elbv2 modify-target-group --target-group-arn ${TG_ARN} --health-check-path /health
              - name: Add Listeners
                type: automatic
                command: aws elbv2 create-listener --load-balancer-arn ${LB_ARN}
                sub_steps:
                  - name: Configure SSL Certificate
                    type: automatic
                    command: aws elbv2 add-listener-certificates --listener-arn ${LISTENER_ARN}
                    sub_steps:
                      - name: Verify SSL Configuration
                        type: manual
                        instruction: Test HTTPS endpoint with curl -v
